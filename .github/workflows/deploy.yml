name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      restart_airflow:
        description: 'Restart Airflow services after deploy'
        required: false
        default: 'false'
        type: boolean

# Ensure only one deployment runs at a time
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # Security scan must pass before deployment
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run Gitleaks (secret detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  # Run tests before deploying
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/unit -v -m "not slow"

  # Deploy only after security scan and tests pass
  deploy:
    runs-on: ubuntu-latest
    needs: [security-scan, test]
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='venv' \
            --exclude='.venv' \
            --exclude='docker/backups/*' \
            --exclude='airflow/logs/*' \
            --exclude='airflow/airflow.db' \
            --exclude='airflow/airflow.cfg' \
            --exclude='nba/betting_xl/lines/*.json' \
            --exclude='nba/betting_xl/predictions/*.json' \
            --exclude='nba/features/datasets/*.csv' \
            --exclude='.env' \
            --exclude='docker/.env' \
            --exclude='*.log' \
            --exclude='*.pkl' \
            --exclude='catboost_info/' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_PATH }}/

      - name: Restart Airflow (if requested)
        if: ${{ github.event.inputs.restart_airflow == 'true' }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            'sudo systemctl restart airflow-scheduler airflow-webserver'

      - name: Verify deployment
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            'cd ${{ secrets.SERVER_PATH }} && source venv/bin/activate && python -c "import nba; print(\"Import OK\")"'

      - name: Post deployment status
        if: always()
        run: |
          echo "Deployment completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
